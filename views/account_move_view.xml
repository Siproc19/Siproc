<odoo>
    <!-- Vista de formulario de factura con campos FEL -->
    <record id="view_move_form_fel" model="ir.ui.view">
        <field name="name">account.move.form.fel</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_move_form"/>
        <field name="arch" type="xml">

            <!-- Botones FEL en el header -->
            <xpath expr="//button[@name='action_post']" position="after">
                <button name="action_certificar_fel"
                        string="Certificar FEL"
                        type="object"
                        class="btn-primary"
                        invisible="state != 'posted' or move_type not in ('out_invoice', 'out_refund') or fel_estado == 'certified'"/>
                <button name="action_anular_fel"
                        string="Anular FEL"
                        type="object"
                        class="btn-danger"
                        confirm="¿Está seguro de anular este documento en FEL? Esta acción no se puede deshacer."
                        invisible="fel_estado != 'certified'"/>
                <button name="action_reintentar_fel"
                        string="Reintentar FEL"
                        type="object"
                        class="btn-warning"
                        invisible="fel_estado != 'error'"/>
                <button name="action_ver_pdf_fel"
                        string="Ver PDF FEL"
                        type="object"
                        class="btn-secondary"
                        icon="fa-file-pdf-o"
                        invisible="not fel_pdf_url"/>
            </xpath>

            <!-- Campos FEL en la factura -->
            <xpath expr="//field[@name='invoice_payment_term_id']" position="after">
                <group string="FEL Guatemala" invisible="move_type not in ('out_invoice', 'out_refund')">
                    <group>
                        <field name="fel_tipo_documento"/>
                        <field name="fel_estado" widget="badge" decoration-success="fel_estado == 'certified'" decoration-danger="fel_estado in ('error', 'cancelled')" decoration-warning="fel_estado == 'pending'"/>
                        <field name="fel_uuid" invisible="not fel_uuid"/>
                    </group>
                    <group>
                        <field name="fel_serie" invisible="not fel_serie"/>
                        <field name="fel_numero" invisible="not fel_numero"/>
                        <field name="fel_fecha_certificacion" invisible="not fel_fecha_certificacion"/>
                        <field name="fel_numero_acceso" invisible="not fel_numero_acceso"/>
                    </group>
                </group>
            </xpath>

            <!-- Pestaña técnica FEL -->
            <xpath expr="//page[@name='other_info']" position="after">
                <page string="FEL Técnico" name="fel_technical" invisible="move_type not in ('out_invoice', 'out_refund')">
                    <group>
                        <group string="Información de Certificación">
                            <field name="fel_pdf_url" widget="url"/>
                            <field name="fel_error_mensaje" invisible="not fel_error_mensaje"/>
                        </group>
                    </group>
                    <group string="XML Enviado" invisible="not fel_xml_enviado">
                        <field name="fel_xml_enviado" nolabel="1" readonly="1"/>
                    </group>
                    <group string="XML Respuesta" invisible="not fel_xml_respuesta">
                        <field name="fel_xml_respuesta" nolabel="1" readonly="1"/>
                    </group>
                </page>
            </xpath>

        </field>
    </record>

    <!-- Vista de lista de facturas con estado FEL -->
    <record id="view_invoice_tree_fel" model="ir.ui.view">
        <field name="name">account.move.tree.fel</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_invoice_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='state']" position="after">
                <field name="fel_estado" widget="badge" optional="show"
                       decoration-success="fel_estado == 'certified'" 
                       decoration-danger="fel_estado in ('error', 'cancelled')" 
                       decoration-warning="fel_estado == 'pending'"/>
                <field name="fel_uuid" optional="hide"/>
            </xpath>
        </field>
    </record>

    <!-- Acción para certificar masivamente (opcional) -->
    <record id="action_certificar_fel_masivo" model="ir.actions.server">
        <field name="name">Certificar FEL</field>
        <field name="model_id" ref="account.model_account_move"/>
        <field name="binding_model_id" ref="account.model_account_move"/>
        <field name="binding_view_types">list</field>
        <field name="state">code</field>
        <field name="code">
for record in records:
    if record.state == 'posted' and record.move_type in ('out_invoice', 'out_refund') and record.fel_estado in ('pending', 'error'):
        try:
            record.action_certificar_fel()
        except Exception as e:
            pass
        </field>
    </record>

</odoo>
